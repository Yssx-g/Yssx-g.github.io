<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>恶意代码分析实战Lab7</title>
      <link href="/2025/11/22/e-yi-dai-ma-fen-xi-shi-zhan-lab7/"/>
      <url>/2025/11/22/e-yi-dai-ma-fen-xi-shi-zhan-lab7/</url>
      
        <content type="html"><![CDATA[<p>这一节我们将接触运用windowsAPI编写的两个恶意程序</p><p>同时会展示该如何调用windowsAPI去恢复已经被污染的exe程序</p><h3 id="Lab07-02"><a href="#Lab07-02" class="headerlink" title="Lab07-02"></a>Lab07-02</h3><p>首先我们使用strings工具对该程序进行初步的分析</p><p><img src="/2025/11/22/e-yi-dai-ma-fen-xi-shi-zhan-lab7/1763803530331.png"></p><p>可以看到一些用于调用windows接口的函数，因此我们要使用一个新的工具Dependency walker去查询该程序的依赖项。</p><p>从而具体分析它调用了哪些函数</p><p><img src="/2025/11/22/e-yi-dai-ma-fen-xi-shi-zhan-lab7/1763803938520.png" alt="依赖项"></p><p>得到了这样的依赖结构（我们在分析的时候会发现OLEAUT32.DLL中是通过序号引入的，此时便可以在下表中查找序号对应的函数）</p><p>我们尝试一下运行该程序</p><p><img src="/2025/11/22/e-yi-dai-ma-fen-xi-shi-zhan-lab7/1763804066734.png"></p><p>发现其效果是试图打开一个网页</p><p>接下来使用IDA进行高级静态分析</p><p><img src="/2025/11/22/e-yi-dai-ma-fen-xi-shi-zhan-lab7/1763804416122.png"></p><p>可以发现一开始的操作是要调用一个windows接口，我们深入其中分析一下调用的接口函数</p><p><img src="/2025/11/22/e-yi-dai-ma-fen-xi-shi-zhan-lab7/1763804508002.png" alt="clsid和iid的具体值"></p><p><img src="/2025/11/22/e-yi-dai-ma-fen-xi-shi-zhan-lab7/1763805261968.png" alt="对应序号"></p><p>我们对该iid进行查询，发现其对应的接口为IWebBrowser2</p><p><img src="/2025/11/22/e-yi-dai-ma-fen-xi-shi-zhan-lab7/1763805289182.png" alt="iid查询"></p><p>接下来再通过clsid在本地注册表 <code>HKEY_LOCAL_MACHINE\SOFTWARE\Classes\CLSID\{0002DF01-0000-0000-C000-000000000046}</code>中查询对应的程序</p><p><img src="/2025/11/22/e-yi-dai-ma-fen-xi-shi-zhan-lab7/1763805630721.png" alt="对应着Internet Explorer"></p><p>继续我们的IDA分析，分析接下来对接口的调用部分</p><p><img src="/2025/11/22/e-yi-dai-ma-fen-xi-shi-zhan-lab7/1763806077530.png" alt="1763806077530"></p><p>可以发现通过ecx将需要的URL赋给了pvarg这个变量，最后又调用了我们的接口，关于其具体的值，可以通过为其设置标准结构体查看</p><p><img src="/2025/11/22/e-yi-dai-ma-fen-xi-shi-zhan-lab7/1763806466340.png"></p><p><img src="/2025/11/22/e-yi-dai-ma-fen-xi-shi-zhan-lab7/1763806613003.png" alt="显示出调用的函数"></p><p>Navigate函数如其名，为我们重定向到一个URL，正是之前给定的ecx中的网址</p><p>到此，该恶意程序的功能全部分析完毕</p><h3 id="Lab07-03"><a href="#Lab07-03" class="headerlink" title="Lab07-03"></a>Lab07-03</h3><p>首先使用strings进行exe分析，发现出现kernel32.dll和kerne132.dll，初步估计该程序将使用伪造的dll文件代替原有dll文件</p><p><img src="/2025/11/22/e-yi-dai-ma-fen-xi-shi-zhan-lab7/1763806780636.png"></p><p>再分析Lab07-03.dll，看到其内部调用了这几个DLL库，猜测该dll文件中存在后门操作，通过WS2_32中的函数创建远程连接</p><p><img src="/2025/11/22/e-yi-dai-ma-fen-xi-shi-zhan-lab7/1763806940842.png"></p><p>接下来使用IDA对两个文件进行具体分析,先来分析Lab07-03.exe</p><p>  <img src="/2025/11/22/e-yi-dai-ma-fen-xi-shi-zhan-lab7/1763807250245.png" alt="要求第二个参数必须存在"></p><p>首先判断程序第二个参数是否为“WARNING_THIS_WILL_DESTROY_YOUR_MACHINE”，如果不是便退出</p><p><img src="/2025/11/22/e-yi-dai-ma-fen-xi-shi-zhan-lab7/1763807622850.png"></p><p><img src="/2025/11/22/e-yi-dai-ma-fen-xi-shi-zhan-lab7/1763807950184.png"></p><p>在内存中加载这两个库文件，并将Lab07-03.dll拷贝到”C:\Windows\System32\Kernel32.dll”路径下，伪装成系统文件</p><p>接下来进入sub_4011E0，查看具体发生了什么</p><p><img src="/2025/11/22/e-yi-dai-ma-fen-xi-shi-zhan-lab7/1763808102048.png"></p><p>经过初步分析可以得知，此处递归搜索了C盘中的每一个exe程序，并且对其进行了sub_4010A0操作，我们继续深入到该函数中进行分析</p><p><img src="/2025/11/22/e-yi-dai-ma-fen-xi-shi-zhan-lab7/1763808286645.png"><img src="/2025/11/22/e-yi-dai-ma-fen-xi-shi-zhan-lab7/1763808304915.png"></p><p>可以看到，这段代码通过内存映射文件的方式修改一个文件的内容，具体来说是将文件的导入表中 <code>kernel32.dll</code> 替换为 <code>kerne132.dll</code>。通过对PE文件结构的解析，精准找到导入表以及对应的kernel32.dll字符串的地址再通过方框中的操作进行替换。</p><p>接下来，我们来分析另一个文件Lab07-03.dll,，由于其内部的具体流程太过复杂，我们截取其中最为关键的函数调用来分析</p><p><img src="/2025/11/22/e-yi-dai-ma-fen-xi-shi-zhan-lab7/1763807319419.png"></p><p>通过dllmain函数的调用，我们可以得到程序的大体流程：</p><p>创建互斥量保证只有单一进程运行；远程连接到指定服务器”127.26.152.13”，并获取指令</p><p><img src="/2025/11/22/e-yi-dai-ma-fen-xi-shi-zhan-lab7/1763811106989.png"></p><p>可能接收到3种指令，”sleep”便休眠程序1min，”q”便清理资源退出程序，”exec”便执行该字段后的指令。此时你的终端便已经被远程主机获取。</p><p>我们尝试修复该程序造成的破坏：首先，运行带有参数的恶意程序，对本地系统进行感染破坏</p><p><img src="/2025/11/22/e-yi-dai-ma-fen-xi-shi-zhan-lab7/1763800721468.png"></p><p>查看之前分析的本地特征，确实发现存在kerne132.dll，并且C盘中的exe程序的依赖项已经被更改为kerne132.dll</p><p><img src="/2025/11/22/e-yi-dai-ma-fen-xi-shi-zhan-lab7/1763800728405.png"></p><p><img src="/2025/11/22/e-yi-dai-ma-fen-xi-shi-zhan-lab7/1763800733341.png" alt="原先的依赖项"></p><p><img src="/2025/11/22/e-yi-dai-ma-fen-xi-shi-zhan-lab7/1763800805590.png" alt="感染后的依赖项"></p><p>接下来我们要完成一个程序，其功能是遍历C盘中的所有exe程序，并修复其导入表为真正的系统库kernel32.dll，示例代码如下（由于笔者学习时尚未熟悉内存映射方式修改文件，该段代码使用的是文件读写的方式）</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;windows.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;tchar.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdarg.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_EXE_COUNT</span> <span class="token expression"><span class="token number">10240</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_PATH_LEN</span>  <span class="token expression"><span class="token number">512</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LOG_BUFFER_LEN</span> <span class="token expression"><span class="token number">1024</span></span></span><span class="token comment">// -------------------------- 全局变量 --------------------------</span>TCHAR<span class="token operator">*</span> g_exeList<span class="token punctuation">[</span>MAX_EXE_COUNT<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">int</span>    g_exeCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// -------------------------- 函数原型声明 --------------------------</span><span class="token keyword">void</span> <span class="token function">FreeEXEList</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">SafeLog</span><span class="token punctuation">(</span><span class="token keyword">const</span> TCHAR<span class="token operator">*</span> format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">ScanEXE</span><span class="token punctuation">(</span><span class="token keyword">const</span> TCHAR<span class="token operator">*</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>BOOL <span class="token function">RepairPE</span><span class="token punctuation">(</span><span class="token keyword">const</span> TCHAR<span class="token operator">*</span> exePath<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">Pause</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 打印</span><span class="token keyword">void</span> <span class="token function">SafeLog</span><span class="token punctuation">(</span><span class="token keyword">const</span> TCHAR<span class="token operator">*</span> format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    TCHAR buffer<span class="token punctuation">[</span>LOG_BUFFER_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>    va_list args<span class="token punctuation">;</span>    <span class="token function">va_start</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> format<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">_vstprintf_s</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> LOG_BUFFER_LEN<span class="token punctuation">,</span> format<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">va_end</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">_tprintf</span><span class="token punctuation">(</span><span class="token function">_T</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//扫描</span><span class="token keyword">void</span> <span class="token function">ScanEXE</span><span class="token punctuation">(</span><span class="token keyword">const</span> TCHAR<span class="token operator">*</span> path<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    TCHAR searchPath<span class="token punctuation">[</span>MAX_PATH_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">_stprintf_s</span><span class="token punctuation">(</span>searchPath<span class="token punctuation">,</span> MAX_PATH_LEN<span class="token punctuation">,</span> <span class="token function">_T</span><span class="token punctuation">(</span><span class="token string">"%s\\*.*"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span>     WIN32_FIND_DATA findData<span class="token punctuation">;</span>    HANDLE hFind <span class="token operator">=</span> <span class="token function">FindFirstFile</span><span class="token punctuation">(</span>searchPath<span class="token punctuation">,</span> <span class="token operator">&amp;</span>findData<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>findData<span class="token punctuation">.</span>dwFileAttributes <span class="token operator">&amp;</span> FILE_ATTRIBUTE_DIRECTORY<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_tcscmp</span><span class="token punctuation">(</span>findData<span class="token punctuation">.</span>cFileName<span class="token punctuation">,</span> <span class="token function">_T</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>                 <span class="token function">_tcscmp</span><span class="token punctuation">(</span>findData<span class="token punctuation">.</span>cFileName<span class="token punctuation">,</span> <span class="token function">_T</span><span class="token punctuation">(</span><span class="token string">".."</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                TCHAR subPath<span class="token punctuation">[</span>MAX_PATH_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token function">_stprintf_s</span><span class="token punctuation">(</span>subPath<span class="token punctuation">,</span> MAX_PATH_LEN<span class="token punctuation">,</span> <span class="token function">_T</span><span class="token punctuation">(</span><span class="token string">"%s\\%s"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> path<span class="token punctuation">,</span> findData<span class="token punctuation">.</span>cFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">ScanEXE</span><span class="token punctuation">(</span>subPath<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            TCHAR<span class="token operator">*</span> ext <span class="token operator">=</span> <span class="token function">_tcsrchr</span><span class="token punctuation">(</span>findData<span class="token punctuation">.</span>cFileName<span class="token punctuation">,</span> <span class="token function">_T</span><span class="token punctuation">(</span><span class="token char">'.'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>ext <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> <span class="token function">_tcsicmp</span><span class="token punctuation">(</span>ext<span class="token punctuation">,</span> <span class="token function">_T</span><span class="token punctuation">(</span><span class="token string">".exe"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                TCHAR<span class="token operator">*</span> fullPath <span class="token operator">=</span> <span class="token punctuation">(</span>TCHAR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>MAX_PATH_LEN <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>TCHAR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token function">_stprintf_s</span><span class="token punctuation">(</span>fullPath<span class="token punctuation">,</span> MAX_PATH_LEN<span class="token punctuation">,</span> <span class="token function">_T</span><span class="token punctuation">(</span><span class="token string">"%s\\%s"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> path<span class="token punctuation">,</span> findData<span class="token punctuation">.</span>cFileName<span class="token punctuation">)</span>                  g_exeList<span class="token punctuation">[</span>g_exeCount<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> fullPath<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">FindNextFile</span><span class="token punctuation">(</span>hFind<span class="token punctuation">,</span> <span class="token operator">&amp;</span>findData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">FindClose</span><span class="token punctuation">(</span>hFind<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 修复</span>BOOL <span class="token function">RepairPE</span><span class="token punctuation">(</span><span class="token keyword">const</span> TCHAR<span class="token operator">*</span> exePath<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    BOOL result <span class="token operator">=</span> FALSE<span class="token punctuation">;</span>     HANDLE hFile <span class="token operator">=</span> INVALID_HANDLE_VALUE<span class="token punctuation">;</span> <span class="token comment">// 初始化文件句柄为无效值</span>    <span class="token comment">// 1. 打开文件</span>    hFile <span class="token operator">=</span> <span class="token function">CreateFile</span><span class="token punctuation">(</span>        exePath<span class="token punctuation">,</span>        GENERIC_READ <span class="token operator">|</span> GENERIC_WRITE<span class="token punctuation">,</span>        FILE_SHARE_READ<span class="token punctuation">,</span>        <span class="token constant">NULL</span><span class="token punctuation">,</span>        OPEN_EXISTING<span class="token punctuation">,</span>        FILE_ATTRIBUTE_NORMAL<span class="token punctuation">,</span>        <span class="token constant">NULL</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>hFile <span class="token operator">==</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        DWORD err <span class="token operator">=</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">SafeLog</span><span class="token punctuation">(</span><span class="token function">_T</span><span class="token punctuation">(</span><span class="token string">"打开文件失败：%s（错误码：%d）\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exePath<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token comment">// 直接跳转到 cleanup 标签</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 2. 读取 DOS 头</span>    IMAGE_DOS_HEADER dosHeader<span class="token punctuation">;</span>    DWORD bytesRead<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>hFile<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dosHeader<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dosHeader<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>bytesRead<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">||</span>         bytesRead <span class="token operator">!=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dosHeader<span class="token punctuation">)</span> <span class="token operator">||</span>         dosHeader<span class="token punctuation">.</span>e_magic <span class="token operator">!=</span> IMAGE_DOS_SIGNATURE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">SafeLog</span><span class="token punctuation">(</span><span class="token function">_T</span><span class="token punctuation">(</span><span class="token string">"无效的 PE 文件：%s（不是 DOS 可执行文件）\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exePath<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token comment">// 读取失败，跳转到 cleanup</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 3. 读取 NT 头</span>    IMAGE_NT_HEADERS32 ntHeader<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SetFilePointer</span><span class="token punctuation">(</span>hFile<span class="token punctuation">,</span> dosHeader<span class="token punctuation">.</span>e_lfanew<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> FILE_BEGIN<span class="token punctuation">)</span> <span class="token operator">==</span> INVALID_SET_FILE_POINTER <span class="token operator">||</span>        <span class="token operator">!</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>hFile<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ntHeader<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ntHeader<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>bytesRead<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">||</span>         bytesRead <span class="token operator">!=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ntHeader<span class="token punctuation">)</span> <span class="token operator">||</span>         ntHeader<span class="token punctuation">.</span>Signature <span class="token operator">!=</span> IMAGE_NT_SIGNATURE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">SafeLog</span><span class="token punctuation">(</span><span class="token function">_T</span><span class="token punctuation">(</span><span class="token string">"无效的 PE 文件：%s（NT 头损坏）\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exePath<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token comment">// 读取失败，跳转到 cleanup</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 4. 定位导入表</span>    IMAGE_DATA_DIRECTORY importDir <span class="token operator">=</span> ntHeader<span class="token punctuation">.</span>OptionalHeader<span class="token punctuation">.</span>DataDirectory<span class="token punctuation">[</span>IMAGE_DIRECTORY_ENTRY_IMPORT<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>importDir<span class="token punctuation">.</span>VirtualAddress <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> importDir<span class="token punctuation">.</span>Size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">SafeLog</span><span class="token punctuation">(</span><span class="token function">_T</span><span class="token punctuation">(</span><span class="token string">"跳过无导入表的文件：%s\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exePath<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token comment">// 无导入表，跳转到 cleanup</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 5. 将 RVA 转换为文件偏移</span>    DWORD importFileOffset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    IMAGE_SECTION_HEADER sectionHeader<span class="token punctuation">;</span>    DWORD sectionTableOffset <span class="token operator">=</span> dosHeader<span class="token punctuation">.</span>e_lfanew <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>IMAGE_NT_HEADERS32<span class="token punctuation">)</span><span class="token punctuation">;</span>    BOOL foundSection <span class="token operator">=</span> FALSE<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>WORD i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ntHeader<span class="token punctuation">.</span>FileHeader<span class="token punctuation">.</span>NumberOfSections<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SetFilePointer</span><span class="token punctuation">(</span>hFile<span class="token punctuation">,</span> sectionTableOffset <span class="token operator">+</span> i <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>IMAGE_SECTION_HEADER<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> FILE_BEGIN<span class="token punctuation">)</span> <span class="token operator">==</span> INVALID_SET_FILE_POINTER <span class="token operator">||</span>            <span class="token operator">!</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>hFile<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sectionHeader<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sectionHeader<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>bytesRead<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">||</span>            bytesRead <span class="token operator">!=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sectionHeader<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">SafeLog</span><span class="token punctuation">(</span><span class="token function">_T</span><span class="token punctuation">(</span><span class="token string">"读取节表失败：%s（节索引：%d）\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exePath<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token comment">// 读取失败，跳转到 cleanup</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>importDir<span class="token punctuation">.</span>VirtualAddress <span class="token operator">>=</span> sectionHeader<span class="token punctuation">.</span>VirtualAddress <span class="token operator">&amp;&amp;</span>            importDir<span class="token punctuation">.</span>VirtualAddress <span class="token operator">&lt;</span> sectionHeader<span class="token punctuation">.</span>VirtualAddress <span class="token operator">+</span> sectionHeader<span class="token punctuation">.</span>SizeOfRawData<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            importFileOffset <span class="token operator">=</span> importDir<span class="token punctuation">.</span>VirtualAddress <span class="token operator">-</span> sectionHeader<span class="token punctuation">.</span>VirtualAddress <span class="token operator">+</span> sectionHeader<span class="token punctuation">.</span>PointerToRawData<span class="token punctuation">;</span>            foundSection <span class="token operator">=</span> TRUE<span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>foundSection<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">SafeLog</span><span class="token punctuation">(</span><span class="token function">_T</span><span class="token punctuation">(</span><span class="token string">"未找到导入表所在节：%s\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exePath<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span> <span class="token comment">// 未找到，跳转到 cleanup</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 6. 遍历导入表并修复恶意 DLL</span>    IMAGE_IMPORT_DESCRIPTOR importDesc<span class="token punctuation">;</span>    BOOL repaired <span class="token operator">=</span> FALSE<span class="token punctuation">;</span>    DWORD currentOffset <span class="token operator">=</span> importFileOffset<span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>TRUE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SetFilePointer</span><span class="token punctuation">(</span>hFile<span class="token punctuation">,</span> currentOffset<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> FILE_BEGIN<span class="token punctuation">)</span> <span class="token operator">==</span> INVALID_SET_FILE_POINTER <span class="token operator">||</span>            <span class="token operator">!</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>hFile<span class="token punctuation">,</span> <span class="token operator">&amp;</span>importDesc<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>importDesc<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>bytesRead<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">||</span>            bytesRead <span class="token operator">!=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>importDesc<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">SafeLog</span><span class="token punctuation">(</span><span class="token function">_T</span><span class="token punctuation">(</span><span class="token string">"读取导入描述符失败：%s（偏移：%d）\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exePath<span class="token punctuation">,</span> currentOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// 这里 break 出 while 循环，之后会走到 cleanup</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>importDesc<span class="token punctuation">.</span>Name <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> importDesc<span class="token punctuation">.</span>FirstThunk <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// 遍历结束</span>        <span class="token punctuation">&#125;</span>        DWORD dllNameRVA <span class="token operator">=</span> importDesc<span class="token punctuation">.</span>Name<span class="token punctuation">;</span>        DWORD dllNameFileOffset <span class="token operator">=</span> dllNameRVA <span class="token operator">-</span> sectionHeader<span class="token punctuation">.</span>VirtualAddress <span class="token operator">+</span> sectionHeader<span class="token punctuation">.</span>PointerToRawData<span class="token punctuation">;</span>        <span class="token keyword">char</span> dllName<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SetFilePointer</span><span class="token punctuation">(</span>hFile<span class="token punctuation">,</span> dllNameFileOffset<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> FILE_BEGIN<span class="token punctuation">)</span> <span class="token operator">==</span> INVALID_SET_FILE_POINTER <span class="token operator">||</span>            <span class="token operator">!</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>hFile<span class="token punctuation">,</span> dllName<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dllName<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>bytesRead<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">||</span>            bytesRead <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">SafeLog</span><span class="token punctuation">(</span><span class="token function">_T</span><span class="token punctuation">(</span><span class="token string">"读取 DLL 名称失败：%s（偏移：%d）\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exePath<span class="token punctuation">,</span> dllNameFileOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>            currentOffset <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>IMAGE_IMPORT_DESCRIPTOR<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        dllName<span class="token punctuation">[</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>dllName<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_stricmp</span><span class="token punctuation">(</span>dllName<span class="token punctuation">,</span> <span class="token string">"kerne132.dll"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            TCHAR backupPath<span class="token punctuation">[</span>MAX_PATH_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> correctDllName <span class="token operator">=</span> <span class="token string">"kernel32.dll"</span><span class="token punctuation">;</span>            DWORD correctNameLen <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>correctDllName<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SetFilePointer</span><span class="token punctuation">(</span>hFile<span class="token punctuation">,</span> dllNameFileOffset<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> FILE_BEGIN<span class="token punctuation">)</span> <span class="token operator">==</span> INVALID_SET_FILE_POINTER <span class="token operator">||</span>                <span class="token operator">!</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>hFile<span class="token punctuation">,</span> correctDllName<span class="token punctuation">,</span> correctNameLen<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bytesRead<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">||</span>                bytesRead <span class="token operator">!=</span> correctNameLen<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">SafeLog</span><span class="token punctuation">(</span><span class="token function">_T</span><span class="token punctuation">(</span><span class="token string">"修复 DLL 名称失败：%s（错误码：%d）\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exePath<span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                repaired <span class="token operator">=</span> TRUE<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        currentOffset <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>IMAGE_IMPORT_DESCRIPTOR<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>      result <span class="token operator">=</span> repaired<span class="token punctuation">;</span><span class="token comment">// 7.回收资源</span>cleanup<span class="token operator">:</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>hFile <span class="token operator">!=</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">CloseHandle</span><span class="token punctuation">(</span>hFile<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//释放内存</span><span class="token keyword">void</span> <span class="token function">FreeEXEList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> g_exeCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>g_exeList<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">free</span><span class="token punctuation">(</span>g_exeList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            g_exeList<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    g_exeCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">Pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">SafeLog</span><span class="token punctuation">(</span><span class="token function">_T</span><span class="token punctuation">(</span><span class="token string">"\n按回车键退出..."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token char">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">_tmain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">SafeLog</span><span class="token punctuation">(</span><span class="token function">_T</span><span class="token punctuation">(</span><span class="token string">"============= PE 文件修复工具（WinXP 32位专用）=============\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">SafeLog</span><span class="token punctuation">(</span><span class="token function">_T</span><span class="token punctuation">(</span><span class="token string">"功能：扫描 C 盘所有 EXE 文件，修复导入表中恶意的 kerne132.dll\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">SafeLog</span><span class="token punctuation">(</span><span class="token function">_T</span><span class="token punctuation">(</span><span class="token string">"===========================================================\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">SafeLog</span><span class="token punctuation">(</span><span class="token function">_T</span><span class="token punctuation">(</span><span class="token string">"开始扫描 C 盘 EXE 文件...\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">ScanEXE</span><span class="token punctuation">(</span><span class="token function">_T</span><span class="token punctuation">(</span><span class="token string">"C:\\"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">SafeLog</span><span class="token punctuation">(</span><span class="token function">_T</span><span class="token punctuation">(</span><span class="token string">"\n扫描完成！共找到 %d 个 EXE 文件，开始修复...\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> g_exeCount<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> g_exeCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>g_exeList<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token function">RepairPE</span><span class="token punctuation">(</span>g_exeList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">SafeLog</span><span class="token punctuation">(</span><span class="token function">_T</span><span class="token punctuation">(</span><span class="token string">"\n修复任务完成！\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">FreeEXEList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">Pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>鉴于笔者在高版本主机中编译的该段程序，为了与winXP兼容，编译命令如下</p><pre class="line-numbers language-gcc" data-language="gcc"><code class="language-gcc">gcc -o repair.exe repair.c -m32 -DWINVER&#x3D;0x0501 -D_WIN32_WINNT&#x3D;0x0501 -static-libgcc -static-libstdc++ -luser32 -lkernel32 -ladvapi32<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>其中的 <code>-DWINVER=0x0501 -D_WIN32_WINNT=0x0501</code>用于指定windows平台为XP。接下来在XP虚拟机中执行修复程序</p><p><img src="/2025/11/22/e-yi-dai-ma-fen-xi-shi-zhan-lab7/1763802571721.png" alt="执行修复程序"></p><p>修复后再次查看C盘中的exe文件依赖项，发现已经被修复为了系统库Kernel32.dll</p><p><img src="/2025/11/22/e-yi-dai-ma-fen-xi-shi-zhan-lab7/1763802578245.png" alt="修复后的依赖"></p><p>至此，本次实验圆满结束</p>]]></content>
      
      
      <categories>
          
          <category> 软件安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 恶意代码分析实战 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>恶意代码分析实战Lab6</title>
      <link href="/2025/11/21/e-yi-dai-ma-fen-xi-shi-zhan-lab6/"/>
      <url>/2025/11/21/e-yi-dai-ma-fen-xi-shi-zhan-lab6/</url>
      
        <content type="html"><![CDATA[<p><strong>本次实验中的前两个程序在分析后发现是后两个程序的功能简化版，因此我们仅对后两个结构不同的实验程序进行分析</strong></p><h3 id="Lab06-03"><a href="#Lab06-03" class="headerlink" title="Lab06-03"></a>Lab06-03</h3><p>首先分析main函数中调用的几个函数</p><p>（1）sub_401271</p><p><img src="/2025/11/21/e-yi-dai-ma-fen-xi-shi-zhan-lab6/1763715890008.png" alt="函数参数"></p><p><img src="/2025/11/21/e-yi-dai-ma-fen-xi-shi-zhan-lab6/1763715907251.png" alt="函数细节"></p><p>可以看到在调用前压入了字符串<strong>Success:xxx</strong>作为参数，在调用过程中又设置了缓冲区等，我们合理推断该函数为printf函数</p><p>（2）sub_401000</p><p><img src="/2025/11/21/e-yi-dai-ma-fen-xi-shi-zhan-lab6/1763716257191.png" alt="函数细节"></p><p>发现函数在 <code>call InternetGetConnectedState</code>后，将结果与0进行比较，并且根据不同的返回结果print两个字符串，由此推断，该函数用于判断当前设备网络连接状态</p><p>（3）sub_401040</p><p><img src="/2025/11/21/e-yi-dai-ma-fen-xi-shi-zhan-lab6/1763716553019.png" alt="构建http请求"></p><p>首先构造http请求，并尝试连接”<a href="http://www.practicalmalwareanalysis.com/">http://www.practicalmalwareanalysis.com</a>“</p><p><img src="/2025/11/21/e-yi-dai-ma-fen-xi-shi-zhan-lab6/1763716674815.png" alt="判断前4字节是否相同"></p><p>其次从该网址中下载512字节数据并判断数组首位4字节是否为**&lt;!–**</p><p><img src="/2025/11/21/e-yi-dai-ma-fen-xi-shi-zhan-lab6/1763718778393.png" alt="返回值"></p><p>如果是，便返回网页中的第五个字节。可以总结出该函数用于从远程网络连接中下载并判断数据</p><p>（4）sub_401130</p><p><img src="/2025/11/21/e-yi-dai-ma-fen-xi-shi-zhan-lab6/1763718977347.png" alt="函数的switch结构"></p><p>通过图标结构可以得知该函数使用了switch结构，接下来我们依次分析各个case</p><p>‘a’:创建目录”C:\Temp”</p><p>‘b’:将lpExistingFileName中的文件资源copy到”C:\Temp\cc.exe”</p><p>‘c’:删除”C:\Temp\cc.exe”文件</p><p>‘d’:向注册表中写入键值对，将”C:\Temp\cc.exe”设置为自启动项，</p><p>‘e’:程序休眠100s</p><p>通过对这个switch结构的分析，我们可以了解这个函数的具体作用了——用于将远程获取的恶意程序拷贝到本地，并且设置为开机自启</p><p>至此我们的程序大体流程便分析完毕了。总结一下，这个程序的作用从连接远程，获取恶意程序，并且设置为开机自启，后续可能会进行远程连接等一系列控制操作</p><h3 id="Lab06-04"><a href="#Lab06-04" class="headerlink" title="Lab06-04"></a>Lab06-04</h3><p>该程序的大体功能与<strong>Lab06-03</strong>相似，不过多了一个循环结构，接下来我们对这两个程序间的不同进行具体分析</p><p><img src="/2025/11/21/e-yi-dai-ma-fen-xi-shi-zhan-lab6/1763719679642.png" alt="main函数流程图"></p><p>由大体的流程图可以发现，在原先<strong>Lab06-03</strong>的流程走完以后，这里将会跳转回函数开头进行循环，下述为循环代码</p><p><img src="/2025/11/21/e-yi-dai-ma-fen-xi-shi-zhan-lab6/1763719787968.png" alt="循环代码"></p><p>分析可得，此处将会循环1440次，又因为每次流程都会sleep60s，可以相乘得出此程序完整运行完需要一天</p><p><img src="/2025/11/21/e-yi-dai-ma-fen-xi-shi-zhan-lab6/1763719911055.png" alt="多出的参数"></p><p><img src="/2025/11/21/e-yi-dai-ma-fen-xi-shi-zhan-lab6/1763719916072.png" alt="Agent每次不同"></p><p>同时我们可以看到，原先的下载远程资源的函数多出了一个参数i，用于记录循环次数并且修改UserAgent的值，使得每次http请求从不同的Agent发出。</p><p>至此该次实验中的恶意程序已经分析完毕</p>]]></content>
      
      
      <categories>
          
          <category> 软件安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 恶意代码分析实战 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>恶意代码分析实战Lab5</title>
      <link href="/2025/11/21/e-yi-dai-ma-fen-xi-shi-zhan-lab5/"/>
      <url>/2025/11/21/e-yi-dai-ma-fen-xi-shi-zhan-lab5/</url>
      
        <content type="html"><![CDATA[<h3 id="Lab05-01"><a href="#Lab05-01" class="headerlink" title="Lab05-01"></a>Lab05-01</h3><p>本次实验主要聚焦于IDApro的基本操作，因此只记录最后的脚本操作范例</p><p>观察python脚本，可以得知脚本作用为解密0x50长度的字符串</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">sea <span class="token operator">=</span> ScreenEA<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x50</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        b <span class="token operator">=</span> Byte<span class="token punctuation">(</span>sea<span class="token operator">+</span>i<span class="token punctuation">)</span>        decoded_byte <span class="token operator">=</span> b <span class="token operator">^</span> <span class="token number">0x55</span>        PatchByte<span class="token punctuation">(</span>sea<span class="token operator">+</span>i<span class="token punctuation">,</span>decoded_byte<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>但由于python脚本环境配置有些许麻烦，笔者在此不使用python语言，而是使用IDApro原生脚本语言idc进行相同操作</p><pre class="line-numbers language-idc" data-language="idc"><code class="language-idc">#include &lt;idc.idc&gt;static main()&#123;auto ea&#x3D;ScreenEA(),b,i,decoded_byte;for(i&#x3D;0x0;i&lt;0x50;i++)&#123;b&#x3D;Byte(ea+i);decoded_byte&#x3D;b^0x55;PatchByte(ea+i,decoded_byte);&#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>脚本语言感觉与C语言很相似，没有太大的理解难度，下面我们执行脚本，可以见到原先的字符串成功解密</p><p><img src="/2025/11/21/e-yi-dai-ma-fen-xi-shi-zhan-lab5/1763656869277.png" alt="解密前字符串"></p><p><img src="/2025/11/21/e-yi-dai-ma-fen-xi-shi-zhan-lab5/1763656899121.png" alt="解密后字符串"></p><p>脚本文件示例结束</p>]]></content>
      
      
      <categories>
          
          <category> 软件安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 恶意代码分析实战 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>恶意代码分析实战Lab3</title>
      <link href="/2025/11/19/e-yi-dai-ma-fen-xi-shi-zhan-lab3/"/>
      <url>/2025/11/19/e-yi-dai-ma-fen-xi-shi-zhan-lab3/</url>
      
        <content type="html"><![CDATA[<h3 id="Lab03-02"><a href="#Lab03-02" class="headerlink" title="Lab03-02"></a>Lab03-02</h3><p>该例实验要求我们进行dll文件的运行，过往的学习中尚未见过要求单独运行dll的样例，特此记录。</p><p>首先准备实验所需工具（Regshot，Process Explorer，Process Monitor）</p><p>运行dll文件的指令很简单</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ rundll32 <span class="token operator">&lt;</span>DLL路径<span class="token operator">></span>,<span class="token operator">&lt;</span>函数名称<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>但记住，此时我们应该使用Regshot工具记录注册表键值，便于一会进行快照的比较</p><p>运行完毕命令以后，进行第二次的快照拍摄，同时进行快照比较，比较后的报告如下图所示：</p><p><img src="/2025/11/19/e-yi-dai-ma-fen-xi-shi-zhan-lab3/1763625273515.png" alt="Regshot 结果"></p><p>可以看出，该dll程序新添了服务项IPRIP，接下来我们便启动这个服务项，</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">net start IPRIP<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>可以看到，la03-02.dll是附着在svchost.exe这个宿主程序上运行的，并且通过PID查找可看到这个程序对系统进行的操作：</p><p><img src="/2025/11/19/e-yi-dai-ma-fen-xi-shi-zhan-lab3/1763625939434.png" alt="查询结果"></p><p>同时使用wireshark抓包，分析网络流量，可以看到可疑的网址和http请求，该文件至此分析完毕：</p><p><img src="/2025/11/19/e-yi-dai-ma-fen-xi-shi-zhan-lab3/1763626430961.png"></p><p><img src="/2025/11/19/e-yi-dai-ma-fen-xi-shi-zhan-lab3/1763626437351.png" alt="分析流量"></p><h3 id="Lab03-03："><a href="#Lab03-03：" class="headerlink" title="Lab03-03："></a>Lab03-03：</h3><p>该程序是一个记录键盘输入的恶意代码，我们一步步对其进行分析</p><p>首先使用Process Exploer观测该程序运行的操作，发现他在创建了一个孤儿进程后自行退出，那么我们仔细观察这个被创建的svchost进程中的字符串信息：</p><p><img src="/2025/11/19/e-yi-dai-ma-fen-xi-shi-zhan-lab3/1763627864079.png" alt="Strings"></p><p>可以发现有大量的键盘字符，初步猜测其目的是记录键盘输入；接下来我们再根据Exploer中找到的PID，在Process Monitor中进行操作查询：</p><p><img src="/2025/11/19/e-yi-dai-ma-fen-xi-shi-zhan-lab3/1763627968227.png" alt="Process EX &amp; Mon"></p><p>发现该程序正在大量的对一个文件进行读写，打开此文件：</p><p><img src="/2025/11/19/e-yi-dai-ma-fen-xi-shi-zhan-lab3/1763628029435.png" alt="结果"></p><p>看到记录着我在哪一程序上输入了哪些信息。</p><p>至此，该恶意代码功能分析完毕</p>]]></content>
      
      
      <categories>
          
          <category> 软件安全 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 恶意代码分析实战 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
